{% extends "base.html" %}
{% load humanize choice_labels static %}
{% block title %}{{ stakeholder.name }} - Control Center{% endblock %}
{% block content %}
<div class="mb-6">
    <div>
        <nav class="flex items-center gap-2 text-sm text-gray-400 mb-2">
            <a href="{% url 'dashboard:index' %}" class="hover:text-gray-300">Home</a>
            <span class="text-gray-600">/</span>
            <a href="{% url 'stakeholders:list' %}" class="hover:text-gray-300">Stakeholders</a>
            <span class="text-gray-600">/</span>
            <span class="text-gray-200">{{ stakeholder.name }}</span>
        </nav>
        <h1 class="text-2xl font-bold text-white mt-1">{{ stakeholder.name }}</h1>
        <p class="text-sm text-gray-400 mt-1">
            {{ stakeholder.entity_type|choice_label:"entity_type" }}{% if stakeholder.parent_organization %} &middot; <a href="{{ stakeholder.parent_organization.get_absolute_url }}" class="text-blue-400 hover:text-blue-300">{{ stakeholder.parent_organization.name }}</a>{% elif stakeholder.organization %} &middot; {{ stakeholder.organization }}{% endif %}
        </p>
    </div>
    <div class="flex flex-wrap gap-2 mt-3">
        <a href="{% url 'stakeholders:export_pdf' stakeholder.pk %}" class="px-3 py-1.5 bg-purple-900/50 hover:bg-purple-900 text-purple-300 text-sm rounded-md transition-colors whitespace-nowrap">PDF</a>
        <a href="{% url 'stakeholders:edit' stakeholder.pk %}" class="px-3 py-1.5 bg-blue-900/50 hover:bg-blue-900 text-blue-300 text-sm rounded-md transition-colors whitespace-nowrap">Edit</a>
        <a href="{% url 'stakeholders:delete' stakeholder.pk %}" class="px-3 py-1.5 bg-red-900/50 hover:bg-red-900 text-red-300 text-sm rounded-md transition-colors whitespace-nowrap">Delete</a>
    </div>
</div>

<!-- Info Cards -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="bg-gray-800 rounded-lg border border-gray-700 p-4">
        <p class="text-xs text-gray-400 uppercase tracking-wide mb-2">Contact</p>
        {% if stakeholder.email %}<p class="text-sm text-gray-200">{{ stakeholder.email }}</p>{% endif %}
        {% if stakeholder.phone %}<p class="text-sm text-gray-200">{{ stakeholder.phone }}</p>{% endif %}
        {% if not stakeholder.email and not stakeholder.phone %}<p class="text-sm text-gray-500">No contact info</p>{% endif %}
    </div>
    <div class="bg-gray-800 rounded-lg border border-gray-700 p-4">
        <p class="text-xs text-gray-400 uppercase tracking-wide mb-2">Trust Rating</p>
        <p class="text-2xl font-bold {% if stakeholder.trust_rating %}{% if stakeholder.trust_rating >= 4 %}text-green-400{% elif stakeholder.trust_rating >= 3 %}text-yellow-400{% else %}text-red-400{% endif %}{% else %}text-gray-500{% endif %}">
            {{ stakeholder.trust_rating|default:"N/A" }}{% if stakeholder.trust_rating %}/5{% endif %}
        </p>
    </div>
    <div class="bg-gray-800 rounded-lg border border-gray-700 p-4">
        <p class="text-xs text-gray-400 uppercase tracking-wide mb-2">Risk Rating</p>
        <p class="text-2xl font-bold {% if stakeholder.risk_rating %}{% if stakeholder.risk_rating >= 4 %}text-red-400{% elif stakeholder.risk_rating >= 3 %}text-yellow-400{% else %}text-green-400{% endif %}{% else %}text-gray-500{% endif %}">
            {{ stakeholder.risk_rating|default:"N/A" }}{% if stakeholder.risk_rating %}/5{% endif %}
        </p>
    </div>
</div>

{% if stakeholder.notes_text %}
<div class="bg-gray-800 rounded-lg border border-gray-700 p-4 mb-6">
    <p class="text-xs text-gray-400 uppercase tracking-wide mb-2">Notes</p>
    <p class="text-sm text-gray-300 whitespace-pre-wrap">{{ stakeholder.notes_text }}</p>
</div>
{% endif %}

{% if stakeholder.entity_type == "firm" %}
<!-- Team Members (Firm) -->
<div class="bg-gray-800 rounded-lg border border-gray-700 mb-6">
    <div class="px-4 py-3 border-b border-gray-700 flex items-center justify-between">
        <h2 class="text-sm font-semibold text-gray-200 uppercase tracking-wide">Team Members <span class="text-xs text-gray-400 font-normal">({{ counts.employees }})</span></h2>
        <div class="flex gap-3">
            <button hx-get="{% url 'stakeholders:employee_add' stakeholder.pk %}"
                    hx-target="#employee-form-container-{{ stakeholder.pk }}"
                    hx-swap="innerHTML"
                    class="text-xs text-blue-400 hover:text-blue-300">+ Add Existing</button>
            <a href="{% url 'stakeholders:create' %}?parent_organization={{ stakeholder.pk }}"
               class="text-xs text-blue-400 hover:text-blue-300">+ Add Employee</a>
        </div>
    </div>
    <div id="employee-form-container-{{ stakeholder.pk }}"></div>
    <div id="employee-list-{{ stakeholder.pk }}">
        {% include "stakeholders/partials/_employee_list.html" %}
    </div>
</div>
{% endif %}

<!-- Contact Logs -->
<div class="bg-gray-800 rounded-lg border border-gray-700 mb-6">
    <div class="px-4 py-3 border-b border-gray-700 flex items-center justify-between">
        <h2 class="text-sm font-semibold text-gray-200 uppercase tracking-wide">Contact Log</h2>
        <button hx-get="{% url 'stakeholders:contact_log_add' stakeholder.pk %}"
                hx-target="#contact-log-form-container"
                hx-swap="innerHTML"
                class="text-xs text-blue-400 hover:text-blue-300">+ Add Entry</button>
    </div>
    <div id="contact-log-form-container"></div>
    <div id="contact-log-list">
        {% include "stakeholders/partials/_contact_log_list.html" %}
    </div>
</div>

<!-- Enhanced Relationship Network -->
<div class="bg-gray-800 rounded-lg border border-gray-700 mb-6">
    <div class="px-4 py-3 border-b border-gray-700">
        <h2 class="text-sm font-semibold text-gray-200 uppercase tracking-wide">Relationship Network</h2>
        <p class="text-xs text-gray-400 mt-1">All connected entities - click any node to navigate</p>
    </div>
    <div id="cy" style="height: 500px; width: 100%;"></div>
    <div class="px-4 py-3 border-t border-gray-700">
        <div class="flex flex-wrap gap-3 text-xs text-gray-400">
            <div class="flex items-center gap-1.5">
                <div class="w-3 h-3 rounded-full bg-blue-500"></div>
                <span>Stakeholders</span>
            </div>
            <div class="flex items-center gap-1.5">
                <div class="w-3 h-3 bg-green-500" style="clip-path: inset(0 0 0 0 round 2px);"></div>
                <span>Properties</span>
            </div>
            <div class="flex items-center gap-1.5">
                <div class="w-3 h-3 bg-purple-500" style="transform: rotate(45deg);"></div>
                <span>Investments</span>
            </div>
            <div class="flex items-center gap-1.5">
                <div class="w-3 h-3 bg-orange-500" style="clip-path: polygon(50% 0%, 0% 100%, 100% 100%);"></div>
                <span>Loans</span>
            </div>
            <div class="flex items-center gap-1.5">
                <div class="w-3 h-3 bg-red-500" style="clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);"></div>
                <span>Legal Matters</span>
            </div>
            <div class="flex items-center gap-1.5">
                <div class="w-3 h-3 bg-yellow-500" style="clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);"></div>
                <span>High-Priority Tasks</span>
            </div>
            <div class="flex items-center gap-1.5">
                <div class="w-3 h-3 bg-teal-500" style="clip-path: polygon(50% 0%, 100% 38%, 82% 100%, 18% 100%, 0% 38%);"></div>
                <span>Vehicles</span>
            </div>
            <div class="flex items-center gap-1.5">
                <div class="w-3 h-3 bg-sky-500" style="clip-path: polygon(50% 0%, 100% 50%, 50% 30%, 0% 50%);"></div>
                <span>Aircraft</span>
            </div>
            <div class="flex items-center gap-1.5">
                <div class="w-3 h-3 bg-pink-500" style="clip-path: polygon(50% 0%, 93% 25%, 93% 75%, 50% 100%, 7% 75%, 7% 25%);"></div>
                <span>Insurance</span>
            </div>
        </div>
    </div>
</div>

<!-- All Connections Tabs -->
<div class="bg-gray-800 rounded-lg border border-gray-700 mb-6">
    <div class="px-4 py-3 border-b border-gray-700">
        <h2 class="text-sm font-semibold text-gray-200 uppercase tracking-wide">All Connections</h2>
    </div>

    <!-- Tab Navigation -->
    <div class="flex flex-wrap border-b border-gray-700 px-4 gap-1">
        <button class="tab-btn px-3 py-2 text-sm border-b-2 border-blue-500 text-blue-400" data-tab="stakeholders">
            Stakeholders <span class="text-xs opacity-70">({{ counts.stakeholders }})</span>
        </button>
        <button class="tab-btn px-3 py-2 text-sm border-b-2 border-transparent text-gray-400 hover:text-gray-300" data-tab="properties">
            Properties <span class="text-xs opacity-70">({{ counts.properties }})</span>
        </button>
        <button class="tab-btn px-3 py-2 text-sm border-b-2 border-transparent text-gray-400 hover:text-gray-300" data-tab="investments">
            Investments <span class="text-xs opacity-70">({{ counts.investments }})</span>
        </button>
        <button class="tab-btn px-3 py-2 text-sm border-b-2 border-transparent text-gray-400 hover:text-gray-300" data-tab="loans">
            Loans <span class="text-xs opacity-70">({{ counts.loans }})</span>
        </button>
        <button class="tab-btn px-3 py-2 text-sm border-b-2 border-transparent text-gray-400 hover:text-gray-300" data-tab="vehicles">
            Vehicles <span class="text-xs opacity-70">({{ counts.vehicles }})</span>
        </button>
        <button class="tab-btn px-3 py-2 text-sm border-b-2 border-transparent text-gray-400 hover:text-gray-300" data-tab="aircraft">
            Aircraft <span class="text-xs opacity-70">({{ counts.aircraft }})</span>
        </button>
        <button class="tab-btn px-3 py-2 text-sm border-b-2 border-transparent text-gray-400 hover:text-gray-300" data-tab="policies">
            Insurance <span class="text-xs opacity-70">({{ counts.policies }})</span>
        </button>
        <button class="tab-btn px-3 py-2 text-sm border-b-2 border-transparent text-gray-400 hover:text-gray-300" data-tab="legal">
            Legal <span class="text-xs opacity-70">({{ counts.legal_matters }})</span>
        </button>
        <button class="tab-btn px-3 py-2 text-sm border-b-2 border-transparent text-gray-400 hover:text-gray-300" data-tab="tasks">
            Tasks <span class="text-xs opacity-70">({{ counts.tasks }})</span>
        </button>
        <button class="tab-btn px-3 py-2 text-sm border-b-2 border-transparent text-gray-400 hover:text-gray-300" data-tab="notes">
            Notes <span class="text-xs opacity-70">({{ counts.notes }})</span>
        </button>
        <button class="tab-btn px-3 py-2 text-sm border-b-2 border-transparent text-gray-400 hover:text-gray-300" data-tab="cashflow">
            Cash Flow <span class="text-xs opacity-70">({{ counts.cashflow }})</span>
        </button>
    </div>

    <!-- Tab Content -->
    <div class="tab-content" id="tab-stakeholders">
        <div class="px-4 py-2 border-b border-gray-700 flex items-center justify-between">
            <span class="text-xs text-gray-400">Relationships with other stakeholders</span>
            <button hx-get="{% url 'stakeholders:relationship_add' stakeholder.pk %}"
                    hx-target="#sh-relationship-form-container"
                    hx-swap="innerHTML"
                    class="text-xs text-blue-400 hover:text-blue-300">+ Add Relationship</button>
        </div>
        <div id="sh-relationship-form-container"></div>
        <div id="sh-relationship-list">
            {% include "stakeholders/partials/_sh_relationship_list.html" %}
        </div>
    </div>

    <div class="tab-content hidden" id="tab-properties">
        <div class="px-4 py-2 border-b border-gray-700 flex items-center justify-between">
            <span class="text-xs text-gray-400">Properties owned by this stakeholder</span>
            <button hx-get="{% url 'stakeholders:property_ownership_add' stakeholder.pk %}"
                    hx-target="#sh-ownership-form-container"
                    hx-swap="innerHTML"
                    class="text-xs text-blue-400 hover:text-blue-300">+ Add Property</button>
        </div>
        <div id="sh-ownership-form-container"></div>
        <div id="sh-ownership-list">
            {% include "stakeholders/partials/_sh_ownership_list.html" with ownerships=property_ownerships %}
        </div>
    </div>

    <div class="tab-content hidden" id="tab-investments">
        <div class="px-4 py-2 border-b border-gray-700 flex items-center justify-between">
            <span class="text-xs text-gray-400">Investments held by this stakeholder</span>
            <button hx-get="{% url 'stakeholders:investment_participant_add' stakeholder.pk %}"
                    hx-target="#sh-participant-form-container"
                    hx-swap="innerHTML"
                    class="text-xs text-blue-400 hover:text-blue-300">+ Add Investment</button>
        </div>
        <div id="sh-participant-form-container"></div>
        <div id="sh-participant-list">
            {% include "stakeholders/partials/_sh_participant_list.html" with participants=investment_participants %}
        </div>
    </div>

    <div class="tab-content hidden" id="tab-loans">
        <div class="px-4 py-2 border-b border-gray-700 flex items-center justify-between">
            <span class="text-xs text-gray-400">Loans involving this stakeholder</span>
            <button hx-get="{% url 'stakeholders:loan_party_add' stakeholder.pk %}"
                    hx-target="#sh-party-form-container"
                    hx-swap="innerHTML"
                    class="text-xs text-blue-400 hover:text-blue-300">+ Add Loan</button>
        </div>
        <div id="sh-party-form-container"></div>
        <div id="sh-party-list">
            {% include "stakeholders/partials/_sh_party_list.html" with parties=loan_parties %}
        </div>
    </div>

    <div class="tab-content hidden" id="tab-vehicles">
        <div class="px-4 py-2 border-b border-gray-700 flex items-center justify-between">
            <span class="text-xs text-gray-400">Vehicles owned by this stakeholder</span>
            <button hx-get="{% url 'stakeholders:vehicle_ownership_add' stakeholder.pk %}"
                    hx-target="#sh-vehicle-form-container"
                    hx-swap="innerHTML"
                    class="text-xs text-blue-400 hover:text-blue-300">+ Add Vehicle</button>
        </div>
        <div id="sh-vehicle-form-container"></div>
        <div id="sh-vehicle-list">
            {% include "stakeholders/partials/_sh_vehicle_list.html" with vehicle_ownerships=vehicle_ownerships %}
        </div>
    </div>

    <div class="tab-content hidden" id="tab-aircraft">
        <div class="px-4 py-2 border-b border-gray-700 flex items-center justify-between">
            <span class="text-xs text-gray-400">Aircraft owned by this stakeholder</span>
            <button hx-get="{% url 'stakeholders:aircraft_ownership_add' stakeholder.pk %}"
                    hx-target="#sh-aircraft-form-container"
                    hx-swap="innerHTML"
                    class="text-xs text-blue-400 hover:text-blue-300">+ Add Aircraft</button>
        </div>
        <div id="sh-aircraft-form-container"></div>
        <div id="sh-aircraft-list">
            {% include "stakeholders/partials/_sh_aircraft_list.html" with aircraft_ownerships=aircraft_ownerships %}
        </div>
    </div>

    <div class="tab-content hidden" id="tab-policies">
        <div class="px-4 py-2 border-b border-gray-700 flex items-center justify-between">
            <span class="text-xs text-gray-400">Insurance policies linked to this stakeholder</span>
            <button hx-get="{% url 'stakeholders:policyholder_add' stakeholder.pk %}"
                    hx-target="#sh-policy-form-container"
                    hx-swap="innerHTML"
                    class="text-xs text-blue-400 hover:text-blue-300">+ Add Policy</button>
        </div>
        <div id="sh-policy-form-container"></div>
        <div id="sh-policy-list">
            {% include "stakeholders/partials/_sh_policy_list.html" %}
        </div>
    </div>

    <div class="tab-content hidden" id="tab-legal">
        <div class="divide-y divide-gray-700">
            {% for matter in all_legal_matters %}
            <a href="{{ matter.get_absolute_url }}" class="flex items-center justify-between px-4 py-3 hover:bg-gray-700/50">
                <div class="flex-1">
                    <span class="text-sm text-gray-200">{{ matter.title }}</span>
                    <span class="text-xs text-gray-400 ml-2">{{ matter.matter_type|choice_label:"matter_type" }}</span>
                </div>
                <span class="text-xs px-2 py-0.5 rounded-full
                    {% if matter.status == 'active' %}bg-green-900/50 text-green-300
                    {% elif matter.status == 'pending' %}bg-yellow-900/50 text-yellow-300
                    {% else %}bg-gray-700 text-gray-300{% endif %}">{{ matter.get_status_display }}</span>
            </a>
            {% empty %}
            <p class="px-4 py-8 text-sm text-gray-500 text-center">No legal matters</p>
            {% endfor %}
        </div>
    </div>

    <div class="tab-content hidden" id="tab-tasks">
        <div class="px-4 py-2 border-b border-gray-700 flex flex-wrap gap-2">
            <a href="{% url 'tasks:create' %}?stakeholder={{ stakeholder.pk }}&direction=outbound" class="text-xs px-2 py-1 bg-cyan-900/50 hover:bg-cyan-900 text-cyan-300 rounded-md transition-colors">+ Request from them</a>
            <a href="{% url 'tasks:create' %}?stakeholder={{ stakeholder.pk }}&direction=inbound" class="text-xs px-2 py-1 bg-amber-900/50 hover:bg-amber-900 text-amber-300 rounded-md transition-colors">+ They requested</a>
        </div>
        <div class="divide-y divide-gray-700">
            {% for task in all_tasks %}
            <a href="{{ task.get_absolute_url }}" class="flex items-center justify-between px-4 py-3 hover:bg-gray-700/50">
                <div class="flex-1">
                    {% if task.direction == "outbound" %}<span class="text-xs text-cyan-400 mr-1">&nearr;</span>{% elif task.direction == "inbound" %}<span class="text-xs text-amber-400 mr-1">&swarr;</span>{% endif %}
                    <span class="text-sm text-gray-200">{{ task.title }}</span>
                    <span class="text-xs px-2 py-0.5 rounded-full ml-2
                        {% if task.priority == 'critical' %}bg-red-900/50 text-red-300
                        {% elif task.priority == 'high' %}bg-orange-900/50 text-orange-300
                        {% elif task.priority == 'medium' %}bg-yellow-900/50 text-yellow-300
                        {% else %}bg-gray-700 text-gray-300{% endif %}">{{ task.get_priority_display }}</span>
                </div>
                <div class="text-right">
                    <span class="text-xs text-gray-400 block">{{ task.due_date|date:"M j, Y"|default:"No date" }}</span>
                    <span class="text-xs px-2 py-0.5 rounded-full
                        {% if task.status == 'complete' %}bg-green-900/50 text-green-300
                        {% elif task.status == 'in_progress' %}bg-blue-900/50 text-blue-300
                        {% else %}bg-gray-700 text-gray-300{% endif %}">{{ task.get_status_display }}</span>
                </div>
            </a>
            {% empty %}
            <p class="px-4 py-8 text-sm text-gray-500 text-center">No tasks</p>
            {% endfor %}
        </div>
    </div>

    <div class="tab-content hidden" id="tab-notes">
        <div class="px-4 py-2 border-b border-gray-700 flex items-center justify-between">
            <span class="text-xs text-gray-400">Notes linked to this stakeholder</span>
            <a href="{% url 'notes:create' %}?stakeholder={{ stakeholder.pk }}"
               class="text-xs text-blue-400 hover:text-blue-300">+ Add Note</a>
        </div>
        <div class="divide-y divide-gray-700">
            {% for note in all_notes %}
            <a href="{{ note.get_absolute_url }}" class="flex items-center justify-between px-4 py-3 hover:bg-gray-700/50">
                <div class="flex-1">
                    <span class="text-sm text-gray-200">{{ note.title }}</span>
                    <span class="text-xs text-gray-400 ml-2">{{ note.note_type|choice_label:"note_type" }}</span>
                </div>
                <span class="text-xs text-gray-400">{{ note.date|date:"M j, Y" }}</span>
            </a>
            {% empty %}
            <p class="px-4 py-8 text-sm text-gray-500 text-center">No notes</p>
            {% endfor %}
        </div>
    </div>

    <div class="tab-content hidden" id="tab-cashflow">
        <div class="px-4 py-2 border-b border-gray-700 flex items-center justify-between">
            <span class="text-xs text-gray-400">Cash flow entries for this stakeholder</span>
            <button hx-get="{% url 'cashflow:stakeholder_cashflow_add' stakeholder.pk %}"
                    hx-target="#sh-cashflow-form-container"
                    hx-swap="innerHTML"
                    class="text-xs text-blue-400 hover:text-blue-300">+ Add Entry</button>
        </div>
        <div id="sh-cashflow-form-container"></div>
        <div id="inline-cashflow-list">
            {% include "cashflow/partials/_inline_cashflow_list.html" %}
        </div>
    </div>
</div>

<!-- Tab Switching Script -->
<script>
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const targetTab = btn.dataset.tab;

        // Update button styles
        document.querySelectorAll('.tab-btn').forEach(b => {
            b.classList.remove('border-blue-500', 'text-blue-400');
            b.classList.add('border-transparent', 'text-gray-400');
        });
        btn.classList.remove('border-transparent', 'text-gray-400');
        btn.classList.add('border-blue-500', 'text-blue-400');

        // Show/hide content
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.add('hidden');
        });
        document.getElementById(`tab-${targetTab}`).classList.remove('hidden');
    });
});
</script>

<!-- Enhanced Cytoscape Graph -->
<script src="{% static 'vendor/cytoscape.min.js' %}"></script>
<script>
(function() {
    fetch("{% url 'stakeholders:graph_data' stakeholder.pk %}")
        .then(r => r.json())
        .then(data => {
            const elements = [];

            // Add nodes
            data.nodes.forEach(n => {
                elements.push({
                    data: {
                        id: n.id,
                        label: n.name,
                        type: n.entity_type,
                        url: n.url,
                        is_center: n.is_center,
                        shape: n.shape
                    }
                });
            });

            // Add edges
            data.edges.forEach(e => {
                elements.push({
                    data: {
                        source: e.source,
                        target: e.target,
                        label: e.label
                    }
                });
            });

            const cy = cytoscape({
                container: document.getElementById('cy'),
                elements: elements,
                style: [
                    // Base node style
                    {
                        selector: 'node',
                        style: {
                            'label': 'data(label)',
                            'text-valign': 'bottom',
                            'text-halign': 'center',
                            'color': '#d1d5db',
                            'font-size': '10px',
                            'text-margin-y': 8,
                            'width': 35,
                            'height': 35,
                            'shape': 'data(shape)',
                        }
                    },
                    // Center node (larger, highlighted)
                    {
                        selector: 'node[?is_center]',
                        style: {
                            'background-color': '#3b82f6',
                            'width': 50,
                            'height': 50,
                            'border-width': 3,
                            'border-color': '#60a5fa',
                            'font-size': '12px',
                            'font-weight': 'bold',
                        }
                    },
                    // Stakeholder nodes (blue circles)
                    {
                        selector: 'node[shape = "ellipse"][!is_center]',
                        style: {
                            'background-color': '#6366f1',
                        }
                    },
                    // Property nodes (green rounded rectangles)
                    {
                        selector: 'node[shape = "roundrectangle"]',
                        style: {
                            'background-color': '#10b981',
                        }
                    },
                    // Investment nodes (purple diamonds)
                    {
                        selector: 'node[shape = "diamond"]',
                        style: {
                            'background-color': '#a855f7',
                        }
                    },
                    // Loan nodes (orange triangles)
                    {
                        selector: 'node[shape = "triangle"]',
                        style: {
                            'background-color': '#f97316',
                        }
                    },
                    // Legal matter nodes (red hexagons)
                    {
                        selector: 'node[shape = "hexagon"]',
                        style: {
                            'background-color': '#ef4444',
                        }
                    },
                    // Task nodes (yellow stars)
                    {
                        selector: 'node[shape = "star"]',
                        style: {
                            'background-color': '#eab308',
                        }
                    },
                    // Vehicle nodes (teal pentagons)
                    {
                        selector: 'node[shape = "pentagon"]',
                        style: {
                            'background-color': '#14b8a6',
                        }
                    },
                    // Aircraft nodes (sky vees)
                    {
                        selector: 'node[shape = "vee"]',
                        style: {
                            'background-color': '#0ea5e9',
                        }
                    },
                    // Insurance policy nodes (pink octagons)
                    {
                        selector: 'node[shape = "octagon"]',
                        style: {
                            'background-color': '#ec4899',
                        }
                    },
                    // Edge styles
                    {
                        selector: 'edge',
                        style: {
                            'label': 'data(label)',
                            'color': '#6b7280',
                            'font-size': '8px',
                            'line-color': '#4b5563',
                            'target-arrow-color': '#4b5563',
                            'target-arrow-shape': 'triangle',
                            'curve-style': 'bezier',
                            'width': 1.5,
                            'text-rotation': 'autorotate',
                            'text-margin-y': -8,
                        }
                    },
                ],
                layout: {
                    name: 'cose',
                    animate: false,
                    padding: 40,
                    nodeRepulsion: 8000,
                    idealEdgeLength: 100,
                },
                userZoomingEnabled: true,
                userPanningEnabled: true,
                minZoom: 0.3,
                maxZoom: 2,
            });

            // Click handler to navigate to entities
            cy.on('tap', 'node', function(evt) {
                const url = evt.target.data('url');
                if (url) window.location.href = url;
            });

            // Hover effect
            cy.on('mouseover', 'node', function(evt) {
                evt.target.style('border-width', 3);
                evt.target.style('border-color', '#60a5fa');
            });
            cy.on('mouseout', 'node', function(evt) {
                if (!evt.target.data('is_center')) {
                    evt.target.style('border-width', 0);
                }
            });
        });
})();
</script>
{% endblock %}
