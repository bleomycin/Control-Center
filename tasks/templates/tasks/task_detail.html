{% extends "base.html" %}
{% block title %}{{ task.title }} - Control Center{% endblock %}
{% block content %}
<div class="mb-6">
    <div>
        <nav class="flex items-center gap-2 text-sm text-gray-400 mb-2">
            <a href="{% url 'dashboard:index' %}" class="hover:text-gray-300">Home</a>
            <span class="text-gray-600">/</span>
            <a href="{% url 'tasks:list' %}" class="hover:text-gray-300">Tasks</a>
            <span class="text-gray-600">/</span>
            <span class="text-gray-200" id="task-breadcrumb-title">{{ task.title }}</span>
        </nav>
        {% include "tasks/partials/_detail_title_display.html" %}
        {% include "tasks/partials/_detail_metadata_display.html" %}
    </div>
    <div class="flex flex-wrap gap-2 mt-3">
        <button hx-post="{% url 'tasks:toggle_complete' task.pk %}" hx-vals='{"context":"detail"}' hx-target="#task-status-area" hx-swap="innerHTML"
                class="px-3 py-1.5 bg-green-900/50 hover:bg-green-900 text-green-300 text-sm rounded-md transition-colors whitespace-nowrap">
            {% if task.status == "complete" %}Reopen{% else %}Complete{% endif %}
        </button>
        <a href="{% url 'tasks:export_pdf' task.pk %}" class="px-3 py-1.5 bg-purple-900/50 hover:bg-purple-900 text-purple-300 text-sm rounded-md transition-colors whitespace-nowrap">PDF</a>
        <a href="{% url 'tasks:edit' task.pk %}" class="px-3 py-1.5 bg-blue-900/50 hover:bg-blue-900 text-blue-300 text-sm rounded-md transition-colors whitespace-nowrap">Edit</a>
        <a href="{% url 'tasks:delete' task.pk %}" class="px-3 py-1.5 bg-red-900/50 hover:bg-red-900 text-red-300 text-sm rounded-md transition-colors whitespace-nowrap">Delete</a>
    </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="bg-gray-800 rounded-lg border border-gray-700 p-4">
        <p class="text-xs text-gray-400 uppercase tracking-wide mb-1">{% if task.is_meeting %}Meeting Time{% else %}Due Date{% endif %}</p>
        <p class="text-sm text-gray-200">{{ task.due_date|date:"F j, Y"|default:"Not set" }}{% if task.due_time %} <span class="text-blue-400">at {{ task.due_time|time:"g:i A" }}</span>{% endif %}</p>
    </div>
    <div class="bg-gray-800 rounded-lg border border-gray-700 p-4">
        <p class="text-xs text-gray-400 uppercase tracking-wide mb-1">{% if task.direction == "outbound" %}Requested From{% elif task.direction == "inbound" %}Requested By{% else %}Stakeholders{% endif %}</p>
        {% with stakeholders=task.related_stakeholders.all %}
        {% if stakeholders %}
        <div class="text-sm">{% for s in stakeholders %}<a href="{{ s.get_absolute_url }}" class="text-blue-400 hover:text-blue-300">{{ s }}</a>{% if not forloop.last %}, {% endif %}{% endfor %}</div>
        {% else %}<p class="text-sm text-gray-500">None</p>{% endif %}
        {% endwith %}
    </div>
    <div class="bg-gray-800 rounded-lg border border-gray-700 p-4">
        <p class="text-xs text-gray-400 uppercase tracking-wide mb-1">Legal Matter</p>
        {% if task.related_legal_matter %}
        <a href="{{ task.related_legal_matter.get_absolute_url }}" class="text-sm text-blue-400 hover:text-blue-300">{{ task.related_legal_matter }}</a>
        {% else %}<p class="text-sm text-gray-500">None</p>{% endif %}
    </div>
</div>

{% include "tasks/partials/_detail_description_display.html" %}

<!-- Checklist -->
<div class="bg-gray-800 rounded-lg border border-gray-700 mb-6">
    <div id="subtask-list">{% include "tasks/partials/_subtask_list.html" %}</div>
</div>

<!-- Follow-ups -->
<div class="bg-gray-800 rounded-lg border border-gray-700 mb-6">
    <div class="px-4 py-3 border-b border-gray-700 flex items-center justify-between">
        <h2 class="text-sm font-semibold text-gray-200 uppercase tracking-wide">Follow-ups</h2>
        <button hx-get="{% url 'tasks:followup_add' task.pk %}" hx-target="#followup-form-container" hx-swap="innerHTML"
                class="text-xs text-blue-400 hover:text-blue-300">+ Add Follow-up</button>
    </div>
    <div id="followup-form-container"></div>
    <div id="followup-list">
        {% include "tasks/partials/_followup_list.html" %}
    </div>
</div>

<!-- Related Notes -->
{% if task.is_meeting %}
<div id="notes-section" class="bg-gray-800 rounded-lg border border-blue-900/50 mb-6">
    <div class="px-4 py-3 border-b border-blue-900/50 flex items-center justify-between">
        <h2 class="text-sm font-semibold text-blue-300 uppercase tracking-wide">Meeting Notes{% if note_count %} <span class="text-xs font-normal text-blue-400/70 ml-1">({{ note_count }})</span>{% endif %}</h2>
        <a href="{% url 'notes:create' %}?task={{ task.pk }}&title=Meeting%20Notes%3A%20{{ task.title|urlencode }}&note_type=meeting{% with s=task.related_stakeholders.first %}{% if s %}&stakeholder={{ s.pk }}{% endif %}{% endwith %}{% if task.due_date %}&date={{ task.due_date|date:'Y-m-d' }}T{% if task.due_time %}{{ task.due_time|time:'H:i' }}{% else %}09:00{% endif %}{% endif %}"
           class="px-3 py-1.5 bg-blue-600 hover:bg-blue-500 text-white text-xs font-medium rounded-md transition-colors">+ Add Meeting Notes</a>
    </div>
    <div class="divide-y divide-gray-700">
        {% for note in notes %}
        <a href="{{ note.get_absolute_url }}" class="flex items-center justify-between px-4 py-3 hover:bg-gray-700/50">
            <span class="text-sm text-gray-200">{{ note.title }}</span>
            <span class="text-xs text-gray-400">{{ note.date|date:"M j" }}</span>
        </a>
        {% empty %}
        <p class="px-4 py-4 text-sm text-gray-500 text-center">No meeting notes yet</p>
        {% endfor %}
    </div>
</div>
{% else %}
<div id="notes-section" class="bg-gray-800 rounded-lg border border-gray-700 mb-6">
    <div class="px-4 py-3 border-b border-gray-700 flex items-center justify-between">
        <h2 class="text-sm font-semibold text-gray-200 uppercase tracking-wide">Notes{% if note_count %} <span class="text-xs font-normal text-gray-400 ml-1">({{ note_count }})</span>{% endif %}</h2>
        <a href="{% url 'notes:create' %}?task={{ task.pk }}" class="text-xs text-blue-400 hover:text-blue-300">+ Add Note</a>
    </div>
    <div class="divide-y divide-gray-700">
        {% for note in notes %}
        <a href="{{ note.get_absolute_url }}" class="flex items-center justify-between px-4 py-3 hover:bg-gray-700/50">
            <span class="text-sm text-gray-200">{{ note.title }}</span>
            <span class="text-xs text-gray-400">{{ note.date|date:"M j" }}</span>
        </a>
        {% empty %}
        <p class="px-4 py-4 text-sm text-gray-500 text-center">No notes</p>
        {% endfor %}
    </div>
</div>
{% endif %}
<script>
document.body.addEventListener('updateTaskBreadcrumb', function(e) {
    var bc = document.getElementById('task-breadcrumb-title');
    if (bc && e.detail && e.detail.value) bc.textContent = e.detail.value;
});
</script>
{% endblock %}
