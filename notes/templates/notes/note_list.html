{% extends "base.html" %}
{% load tag_colors %}
{% block title %}Notes - Control Center{% endblock %}
{% block content %}
<div class="flex items-center justify-between mb-4 sm:mb-6">
    <div>
        <h1 class="text-2xl font-bold text-white">Notes</h1>
    </div>
    <div class="flex items-center gap-1.5 sm:gap-2">
        <!-- View toggle: icon-only on mobile, icon+text on desktop -->
        <div class="flex items-center gap-1">
            <button id="btn-cards" onclick="switchNoteView('cards')" class="px-2 py-1 sm:px-2.5 text-xs rounded-md transition-colors {% if current_view == 'cards' %}bg-blue-900/50 text-blue-300{% else %}text-gray-400 hover:text-gray-200 hover:bg-gray-700{% endif %}">
                <svg class="w-4 h-4 inline-block sm:mr-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/></svg>
                <span class="hidden sm:inline">Cards</span>
            </button>
            <button id="btn-list" onclick="switchNoteView('list')" class="px-2 py-1 sm:px-2.5 text-xs rounded-md transition-colors {% if current_view == 'list' %}bg-blue-900/50 text-blue-300{% else %}text-gray-400 hover:text-gray-200 hover:bg-gray-700{% endif %}">
                <svg class="w-4 h-4 inline-block sm:mr-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/></svg>
                <span class="hidden sm:inline">List</span>
            </button>
            <button id="btn-timeline" onclick="switchNoteView('timeline')" class="px-2 py-1 sm:px-2.5 text-xs rounded-md transition-colors {% if current_view == 'timeline' %}bg-blue-900/50 text-blue-300{% else %}text-gray-400 hover:text-gray-200 hover:bg-gray-700{% endif %}">
                <svg class="w-4 h-4 inline-block sm:mr-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                <span class="hidden sm:inline">Timeline</span>
            </button>
        </div>
        <a href="{% url 'notes:export_csv' %}" class="hidden sm:inline-block px-3 py-1.5 bg-purple-900/50 hover:bg-purple-900 text-purple-300 text-sm font-medium rounded-md transition-colors whitespace-nowrap">Export CSV</a>
        <a href="{% url 'notes:create' %}" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-500 text-white text-sm font-medium rounded-md transition-colors whitespace-nowrap">+ New</a>
    </div>
</div>

<!-- Mobile Folder Dropdown -->
<div class="sm:hidden flex items-center gap-2 mb-3">
    <select id="mobile-folder-select" onchange="switchFolder(this.value)"
            class="flex-1 rounded-md border-gray-600 bg-gray-800 text-gray-100 text-sm px-2 py-2">
        <option value="" {% if current_folder == '' or current_folder == 'all' %}selected{% endif %}>All Notes</option>
        {% for folder in folders %}
        <option value="{{ folder.pk }}" {% if current_folder == folder.pk|stringformat:'d' %}selected{% endif %}>{{ folder.name }} ({{ folder.note_count }})</option>
        {% endfor %}
        <option value="unfiled" {% if current_folder == 'unfiled' %}selected{% endif %}>Unfiled ({{ unfiled_count }})</option>
    </select>
    <button onclick="document.getElementById('folder-manage-panel').classList.toggle('hidden')"
            class="px-2 py-2 text-gray-500 hover:text-gray-300 transition-colors" title="Manage folders">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
    </button>
</div>

<!-- Desktop Folder Tabs -->
<div id="folder-tabs" class="hidden sm:flex flex-wrap gap-1 mb-4 border-b border-gray-700 pb-2 items-center"
     hx-get="{% url 'notes:folder_tabs' %}" hx-trigger="foldersChanged from:body" hx-include="#current-folder" hx-swap="innerHTML">
    {% include "notes/partials/_folder_tabs.html" %}
</div>

<!-- Inline Folder Management Panel -->
<div id="folder-manage-panel" class="hidden bg-gray-800 rounded-lg border border-gray-700 mb-4">
    <div class="px-4 py-3 border-b border-gray-700 flex items-center justify-between">
        <h2 class="text-sm font-semibold text-gray-200 uppercase tracking-wide">Manage Folders</h2>
        <button hx-get="{% url 'notes:folder_add' %}" hx-target="#folder-form-container" hx-swap="innerHTML"
                class="text-xs text-blue-400 hover:text-blue-300">+ Add Folder</button>
    </div>
    <div id="folder-form-container"></div>
    <div id="folder-list">
        {% include "notes/partials/_folder_list.html" %}
    </div>
</div>

{% with filter_count=selected_types|length %}
<form id="filter-form" onsubmit="return false;" class="mb-4">
    <input type="hidden" name="folder" id="current-folder" value="{{ current_folder }}">
    <input type="hidden" name="view" id="current-view" value="{{ current_view }}">
    <!-- Search bar -->
    <div class="mb-2 sm:mb-3">
        <input type="text" name="q" value="{{ search_query }}" placeholder="Search notes..."
               hx-get="{% url 'notes:list' %}" hx-trigger="keyup changed delay:300ms" hx-target="#note-content" hx-include="#filter-form" hx-indicator="#loading-spinner"
               class="w-full rounded-md border-gray-600 bg-gray-800 text-gray-100 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm px-3 py-2">
    </div>
    <!-- Dropdowns row: 2-col grid on mobile, inline flex on desktop -->
    <div class="grid grid-cols-2 gap-2 sm:flex sm:flex-wrap sm:gap-2 mb-2 sm:mb-3">
        <select name="stakeholder" hx-get="{% url 'notes:list' %}" hx-trigger="change" hx-target="#note-content" hx-include="#filter-form" hx-indicator="#loading-spinner"
                class="rounded-md border-gray-600 bg-gray-800 text-gray-100 text-sm px-2 py-2 sm:px-3">
            <option value="">All People</option>
            {% for s in stakeholders %}<option value="{{ s.pk }}" {% if selected_stakeholder == s.pk|stringformat:"d" %}selected{% endif %}>{{ s.name }}</option>{% endfor %}
        </select>
        <button type="button" id="note-filter-toggle-btn" onclick="toggleNoteFilters()"
                class="inline-flex items-center justify-center gap-1.5 px-2 py-2 sm:px-3 text-sm font-medium rounded-md transition-colors {% if selected_types or selected_tags or date_from or date_to %}bg-blue-600/20 border border-blue-500 text-blue-300{% else %}bg-gray-700 border border-gray-600 text-gray-300 hover:bg-gray-600{% endif %}">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/></svg>
            Filters
            {% if filter_count or selected_tags or date_from or date_to %}
            <span class="inline-flex items-center justify-center w-5 h-5 text-xs font-bold bg-blue-500 text-white rounded-full" id="note-filter-count">{% if filter_count %}{{ filter_count }}{% else %}&bull;{% endif %}</span>
            {% endif %}
        </button>
    </div>

    <!-- Collapsible filter panel -->
    <div id="note-filter-panel" class="{% if not selected_types and not selected_tags and not date_from and not date_to %}hidden{% endif %} bg-gray-800 rounded-lg border border-gray-700 p-3 mb-3">
        <div class="flex flex-col gap-3 sm:flex-row sm:flex-wrap sm:gap-x-6 sm:gap-y-3 sm:items-center">
            <!-- Type filter pills -->
            <div>
                <span class="text-xs text-gray-400 font-medium mr-1">Type:</span>
                <div class="flex flex-wrap gap-1.5 mt-1 sm:mt-0 sm:inline-flex items-center">
                    {% for val, label in note_types %}
                    {% note_type_classes val as ntc %}
                    <label class="cursor-pointer">
                        <input type="checkbox" name="type" value="{{ val }}"
                               {% if val in selected_types %}checked{% endif %}
                               hx-get="{% url 'notes:list' %}" hx-trigger="change" hx-target="#note-content"
                               hx-include="#filter-form" hx-indicator="#loading-spinner"
                               class="hidden"
                               onchange="toggleTypePill(this, '{{ ntc.bg }}', '{{ ntc.text }}', '{{ ntc.border }}')">
                        <span class="inline-flex items-center text-xs px-2 py-0.5 rounded-full border transition-colors
                                     {% if val in selected_types %}{{ ntc.bg }} {{ ntc.text }} {{ ntc.border }}{% else %}border-gray-600 text-gray-500 hover:text-gray-300 hover:border-gray-500{% endif %}"
                              data-active-bg="{{ ntc.bg }}" data-active-text="{{ ntc.text }}" data-active-border="{{ ntc.border }}">
                            {{ label }}
                        </span>
                    </label>
                    {% endfor %}
                </div>
            </div>
            <!-- Tag filter pills -->
            {% if all_tags %}
            <div>
                <span class="text-xs text-gray-400 font-medium mr-1">Tags:</span>
                <div class="flex flex-wrap gap-1.5 mt-1 sm:mt-0 sm:inline-flex items-center">
                    {% for tag in all_tags %}
                    {% tag_classes tag.color as tc %}
                    <label class="cursor-pointer">
                        <input type="checkbox" name="tag" value="{{ tag.slug }}"
                               {% if tag.slug in selected_tags %}checked{% endif %}
                               hx-get="{% url 'notes:list' %}" hx-trigger="change" hx-target="#note-content"
                               hx-include="#filter-form" hx-indicator="#loading-spinner"
                               class="hidden"
                               onchange="toggleTypePill(this, '{{ tc.bg }}', '{{ tc.text }}', '{{ tc.border }}')">
                        <span class="inline-flex items-center text-xs px-2 py-0.5 rounded-full border transition-colors
                                     {% if tag.slug in selected_tags %}{{ tc.bg }} {{ tc.text }} {{ tc.border }}{% else %}border-gray-600 text-gray-500 hover:text-gray-300 hover:border-gray-500{% endif %}"
                              data-active-bg="{{ tc.bg }}" data-active-text="{{ tc.text }}" data-active-border="{{ tc.border }}">
                            #{{ tag.name }}
                        </span>
                    </label>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            <!-- Date range -->
            <div class="w-full sm:w-auto">
                <span class="text-xs text-gray-400 font-medium">Date:</span>
                <div class="flex items-center gap-2 mt-1 sm:mt-0 sm:inline-flex">
                    <input type="date" name="date_from" value="{{ date_from }}"
                           hx-get="{% url 'notes:list' %}" hx-trigger="change" hx-target="#note-content" hx-include="#filter-form" hx-indicator="#loading-spinner"
                           class="flex-1 sm:flex-none rounded-md border-gray-600 bg-gray-800 text-gray-100 sm:text-sm px-2 py-1.5">
                    <span class="text-xs text-gray-500">to</span>
                    <input type="date" name="date_to" value="{{ date_to }}"
                           hx-get="{% url 'notes:list' %}" hx-trigger="change" hx-target="#note-content" hx-include="#filter-form" hx-indicator="#loading-spinner"
                           class="flex-1 sm:flex-none rounded-md border-gray-600 bg-gray-800 text-gray-100 sm:text-sm px-2 py-1.5">
                </div>
            </div>
            <button type="button" onclick="clearNoteFilters()" class="text-xs text-gray-400 hover:text-white transition-colors underline underline-offset-2 self-start sm:self-center">Clear</button>
        </div>
    </div>
</form>
{% endwith %}

<div id="loading-spinner" class="htmx-indicator flex justify-center py-2"><div class="loading-spinner"></div></div>

<div id="bulk-bar" class="hidden bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 mb-3 flex flex-wrap items-center gap-3">
    <span class="text-sm text-gray-300"><span id="bulk-count">0</span> selected</span>
    <form method="post" action="{% url 'notes:bulk_delete' %}" class="inline">
        {% csrf_token %}
        <button type="submit" onclick="document.querySelectorAll('input[name=selected]:checked').forEach(cb => {const h = document.createElement('input'); h.type='hidden'; h.name='selected'; h.value=cb.value; this.form.appendChild(h);})"
                class="px-3 py-1 bg-red-900/50 hover:bg-red-900 text-red-300 text-xs font-medium rounded-md transition-colors">Delete Selected</button>
    </form>
    <button onclick="const pks = Array.from(document.querySelectorAll('input[name=selected]:checked')).map(cb => cb.value); window.location.href='{% url 'notes:bulk_export_csv' %}?' + pks.map(pk => 'selected=' + pk).join('&');"
            class="px-3 py-1 bg-purple-900/50 hover:bg-purple-900 text-purple-300 text-xs font-medium rounded-md transition-colors">Export Selected</button>
    {% if all_tags %}
    <button onclick="document.getElementById('bulk-tag-panel').classList.toggle('hidden'); var fp=document.getElementById('bulk-folder-panel'); if(fp) fp.classList.add('hidden');"
            class="px-3 py-1 bg-blue-900/50 hover:bg-blue-900 text-blue-300 text-xs font-medium rounded-md transition-colors">Tag</button>
    {% endif %}
    {% if folders %}
    <button onclick="document.getElementById('bulk-folder-panel').classList.toggle('hidden'); var tp=document.getElementById('bulk-tag-panel'); if(tp) tp.classList.add('hidden');"
            class="px-3 py-1 bg-green-900/50 hover:bg-green-900 text-green-300 text-xs font-medium rounded-md transition-colors">Move to Folder</button>
    {% endif %}
</div>

<!-- Bulk Tag Panel -->
{% if all_tags %}
<div id="bulk-tag-panel" class="hidden bg-gray-800 border border-gray-600 rounded-lg px-4 py-3 mb-3">
    <form id="bulk-tag-form" hx-post="{% url 'notes:bulk_apply_tags' %}" hx-swap="none"
          hx-on::after-request="closeBulkTagPanel()" class="flex flex-wrap items-center gap-2">
        {% csrf_token %}
        <input type="hidden" name="mode" id="bulk-tag-mode" value="add">
        <div class="flex items-center gap-1 mr-2">
            <button type="button" id="tag-mode-add" onclick="setBulkTagMode('add')"
                    class="px-2 py-0.5 text-xs rounded-l-md border border-gray-600 bg-blue-900/50 text-blue-300">Add</button>
            <button type="button" id="tag-mode-remove" onclick="setBulkTagMode('remove')"
                    class="px-2 py-0.5 text-xs rounded-r-md border border-gray-600 text-gray-400 hover:text-gray-200">Remove</button>
        </div>
        {% for tag in all_tags %}
        {% tag_classes tag.color as tc %}
        <label class="cursor-pointer" onclick="event.stopPropagation()">
            <input type="checkbox" name="tags" value="{{ tag.pk }}" class="hidden"
                   onchange="toggleTagPill(this, '{{ tc.bg }}', '{{ tc.text }}', '{{ tc.border }}')">
            <span class="bulk-tag-pill inline-flex items-center text-xs px-2 py-0.5 rounded-full border transition-colors
                         border-gray-600 text-gray-500 hover:text-gray-300 hover:border-gray-500"
                  data-active-bg="{{ tc.bg }}" data-active-text="{{ tc.text }}" data-active-border="{{ tc.border }}">
                #{{ tag.name }}
            </span>
        </label>
        {% endfor %}
        <button type="submit" id="bulk-tag-submit"
                onclick="document.querySelectorAll('input[name=selected]:checked').forEach(cb => {const h = document.createElement('input'); h.type='hidden'; h.name='selected'; h.value=cb.value; document.getElementById('bulk-tag-form').appendChild(h);})"
                class="px-3 py-1 bg-blue-600 hover:bg-blue-500 text-white text-xs font-medium rounded-md transition-colors ml-2">Apply</button>
    </form>
</div>
{% endif %}

<!-- Bulk Folder Panel -->
{% if folders %}
<div id="bulk-folder-panel" class="hidden bg-gray-800 border border-gray-600 rounded-lg px-4 py-3 mb-3">
    <form id="bulk-folder-form" hx-post="{% url 'notes:bulk_move_folder' %}" hx-swap="none"
          hx-on::after-request="document.getElementById('bulk-folder-panel').classList.add('hidden')" class="flex flex-wrap items-center gap-2">
        {% csrf_token %}
        <span class="text-xs text-gray-400">Move to:</span>
        <select name="folder" class="rounded-md border-gray-600 bg-gray-700 text-gray-100 sm:text-sm px-2 py-1">
            <option value="">Unfiled</option>
            {% for folder in folders %}
            <option value="{{ folder.pk }}">{{ folder.name }}</option>
            {% endfor %}
        </select>
        <button type="submit" onclick="document.querySelectorAll('input[name=selected]:checked').forEach(cb => {const h = document.createElement('input'); h.type='hidden'; h.name='selected'; h.value=cb.value; document.getElementById('bulk-folder-form').appendChild(h);})"
                class="px-3 py-1 bg-green-600 hover:bg-green-500 text-white text-xs font-medium rounded-md transition-colors">Move</button>
    </form>
</div>
{% endif %}

<div id="note-content"
     hx-get="{% url 'notes:list' %}" hx-trigger="noteListChanged from:body" hx-include="#filter-form" hx-indicator="#loading-spinner">
    {% if current_view == "list" %}{% include "notes/partials/_note_table_view.html" %}{% elif current_view == "timeline" %}{% include "notes/partials/_note_timeline_view.html" %}{% else %}{% include "notes/partials/_note_list_content.html" %}{% endif %}
</div>

<script>
function switchFolder(folderId) {
    document.getElementById('current-folder').value = folderId;
    // Sync mobile dropdown
    var mobileSelect = document.getElementById('mobile-folder-select');
    if (mobileSelect) mobileSelect.value = folderId;
    // Update tab highlights via JS (no full page reload)
    var inactiveClasses = 'text-gray-400 hover:text-gray-200 hover:bg-gray-700/50';
    document.querySelectorAll('.folder-tab').forEach(function(btn) {
        var tabId = btn.dataset.folder;
        // Strip all possible active classes
        btn.className = btn.className
            .replace(/bg-blue-900\/50|text-blue-300|bg-gray-700(?!\/)|text-gray-200(?!\s*hover)/g, '')
            .replace(/bg-\w+-900\/\d+|text-\w+-\d+/g, '');
        if (tabId === folderId || (tabId === '' && folderId === '')) {
            // Apply active style
            if (tabId === '' || tabId === 'unfiled') {
                btn.className = btn.className.replace(inactiveClasses, '') + (tabId === '' ? ' bg-blue-900/50 text-blue-300' : ' bg-gray-700 text-gray-200');
            } else {
                var activeClasses = btn.dataset.activeClasses || 'bg-blue-900/50 text-blue-300';
                btn.className = btn.className.replace(inactiveClasses, '') + ' ' + activeClasses;
            }
        } else {
            btn.className = btn.className + ' ' + inactiveClasses;
        }
        // Clean up extra whitespace
        btn.className = btn.className.replace(/\s+/g, ' ').trim();
    });
    htmx.ajax('GET', '{% url "notes:list" %}', {
        target: '#note-content',
        source: document.getElementById('filter-form'),
        indicator: '#loading-spinner'
    });
    var url = new URL(window.location);
    if (folderId) { url.searchParams.set('folder', folderId); } else { url.searchParams.delete('folder'); }
    url.searchParams.delete('page');
    history.pushState({}, '', url);
}

function closeBulkTagPanel() {
    document.getElementById('bulk-tag-panel').classList.add('hidden');
    // Reset all tag pill checkboxes and visuals
    document.querySelectorAll('#bulk-tag-form input[name=tags]').forEach(function(cb) {
        cb.checked = false;
        var span = cb.nextElementSibling;
        var bg = span.dataset.activeBg;
        var text = span.dataset.activeText;
        var border = span.dataset.activeBorder;
        if (bg) span.classList.remove(...bg.split(' '));
        if (text) span.classList.remove(...text.split(' '));
        if (border) span.classList.remove(...border.split(' '));
        span.classList.add('border-gray-600', 'text-gray-500');
    });
    // Remove injected hidden selected inputs
    document.querySelectorAll('#bulk-tag-form input[name=selected]').forEach(function(h) { h.remove(); });
    // Reset mode to add
    setBulkTagMode('add');
}

function toggleTagPill(checkbox, bgClass, textClass, borderClass) {
    var span = checkbox.nextElementSibling;
    if (checkbox.checked) {
        span.classList.add(...bgClass.split(' '), ...textClass.split(' '), ...borderClass.split(' '));
        span.classList.remove('border-gray-600', 'text-gray-500');
    } else {
        span.classList.remove(...bgClass.split(' '), ...textClass.split(' '), ...borderClass.split(' '));
        span.classList.add('border-gray-600', 'text-gray-500');
    }
}

function toggleTypePill(checkbox, bgClass, textClass, borderClass) {
    var span = checkbox.nextElementSibling;
    if (checkbox.checked) {
        span.classList.add(...bgClass.split(' '), ...textClass.split(' '), ...borderClass.split(' '));
        span.classList.remove('border-gray-600', 'text-gray-500');
    } else {
        span.classList.remove(...bgClass.split(' '), ...textClass.split(' '), ...borderClass.split(' '));
        span.classList.add('border-gray-600', 'text-gray-500');
    }
}

function setBulkTagMode(mode) {
    document.getElementById('bulk-tag-mode').value = mode;
    var addBtn = document.getElementById('tag-mode-add');
    var removeBtn = document.getElementById('tag-mode-remove');
    var submitBtn = document.getElementById('bulk-tag-submit');
    if (mode === 'remove') {
        addBtn.className = 'px-2 py-0.5 text-xs rounded-l-md border border-gray-600 text-gray-400 hover:text-gray-200';
        removeBtn.className = 'px-2 py-0.5 text-xs rounded-r-md border border-gray-600 bg-red-900/50 text-red-300';
        submitBtn.textContent = 'Remove';
        submitBtn.className = 'px-3 py-1 bg-red-600 hover:bg-red-500 text-white text-xs font-medium rounded-md transition-colors ml-2';
    } else {
        addBtn.className = 'px-2 py-0.5 text-xs rounded-l-md border border-gray-600 bg-blue-900/50 text-blue-300';
        removeBtn.className = 'px-2 py-0.5 text-xs rounded-r-md border border-gray-600 text-gray-400 hover:text-gray-200';
        submitBtn.textContent = 'Apply';
        submitBtn.className = 'px-3 py-1 bg-blue-600 hover:bg-blue-500 text-white text-xs font-medium rounded-md transition-colors ml-2';
    }
}

function toggleNoteFilters() {
    var panel = document.getElementById('note-filter-panel');
    var btn = document.getElementById('note-filter-toggle-btn');
    panel.classList.toggle('hidden');
    var isOpen = !panel.classList.contains('hidden');
    if (isOpen) {
        btn.classList.add('bg-blue-600/20', 'border-blue-500', 'text-blue-300');
        btn.classList.remove('bg-gray-700', 'border-gray-600', 'text-gray-300', 'hover:bg-gray-600');
    } else if (!document.querySelector('#note-filter-panel input:checked') && !Array.from(document.querySelectorAll('#note-filter-panel input[type=date]')).some(function(d) { return d.value; })) {
        btn.classList.remove('bg-blue-600/20', 'border-blue-500', 'text-blue-300');
        btn.classList.add('bg-gray-700', 'border-gray-600', 'text-gray-300', 'hover:bg-gray-600');
    }
}

function clearNoteFilters() {
    var panel = document.getElementById('note-filter-panel');
    panel.querySelectorAll('input[type=checkbox]').forEach(function(cb) {
        cb.checked = false;
        // Reset pill visuals for type and tag pills
        var span = cb.nextElementSibling;
        if (span && span.dataset.activeBg) {
            span.classList.remove(...(span.dataset.activeBg || '').split(' '), ...(span.dataset.activeText || '').split(' '), ...(span.dataset.activeBorder || '').split(' '));
            span.classList.add('border-gray-600', 'text-gray-500');
        }
    });
    panel.querySelectorAll('input[type=date]').forEach(function(d) { d.value = ''; });
    var badge = document.getElementById('note-filter-count');
    if (badge) badge.remove();
    var btn = document.getElementById('note-filter-toggle-btn');
    btn.classList.remove('bg-blue-600/20', 'border-blue-500', 'text-blue-300');
    btn.classList.add('bg-gray-700', 'border-gray-600', 'text-gray-300', 'hover:bg-gray-600');
    htmx.ajax('GET', '{% url "notes:list" %}', {
        target: '#note-content',
        swap: 'innerHTML',
        source: document.getElementById('filter-form'),
    });
}

function toggleNoteExpand(pk) {
    var preview = document.getElementById('note-preview-' + pk);
    var full = document.getElementById('note-full-' + pk);
    var btn = document.getElementById('note-expand-btn-' + pk);
    if (full.classList.contains('hidden')) {
        preview.classList.add('hidden');
        full.classList.remove('hidden');
        btn.textContent = 'Show less';
    } else {
        preview.classList.remove('hidden');
        full.classList.add('hidden');
        btn.textContent = 'Show more';
    }
}

function switchNoteView(mode) {
    document.getElementById('current-view').value = mode;
    // Update button classes
    ['cards', 'list', 'timeline'].forEach(function(m) {
        var btn = document.getElementById('btn-' + m);
        if (m === mode) {
            btn.className = btn.className.replace(/text-gray-400 hover:text-gray-200 hover:bg-gray-700/g, '').replace(/bg-blue-900\/50 text-blue-300/g, '') + ' bg-blue-900/50 text-blue-300';
        } else {
            btn.className = btn.className.replace(/bg-blue-900\/50 text-blue-300/g, '') + ' text-gray-400 hover:text-gray-200 hover:bg-gray-700';
        }
    });
    htmx.ajax('GET', '{% url "notes:list" %}', {
        target: '#note-content',
        source: document.getElementById('filter-form'),
        indicator: '#loading-spinner'
    });
    var url = new URL(window.location);
    if (mode !== 'cards') { url.searchParams.set('view', mode); } else { url.searchParams.delete('view'); }
    url.searchParams.delete('page');
    history.pushState({}, '', url);
}
</script>
{% endblock %}
