{% extends "base.html" %}
{% block title %}Calendar - Control Center{% endblock %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<style>
    /* Dark theme overrides for FullCalendar */
    .fc {
        --fc-border-color: #374151;
        --fc-button-bg-color: #374151;
        --fc-button-border-color: #4b5563;
        --fc-button-hover-bg-color: #4b5563;
        --fc-button-hover-border-color: #6b7280;
        --fc-button-active-bg-color: #2563eb;
        --fc-button-active-border-color: #2563eb;
        --fc-today-bg-color: rgba(59, 130, 246, 0.1);
        --fc-neutral-bg-color: #1f2937;
        --fc-page-bg-color: #111827;
        --fc-event-border-color: transparent;
        --fc-list-event-hover-bg-color: #1f2937;
    }
    .fc .fc-col-header-cell-cushion,
    .fc .fc-daygrid-day-number,
    .fc .fc-toolbar-title {
        color: #e5e7eb;
    }
    .fc .fc-button {
        color: #e5e7eb;
        font-size: 0.875rem;
    }
    .fc .fc-daygrid-day.fc-day-today {
        background-color: rgba(59, 130, 246, 0.1);
    }
    .fc .fc-event {
        cursor: pointer;
        font-size: 0.75rem;
        padding: 1px 4px;
        border-radius: 3px;
    }
    .fc .fc-col-header-cell {
        background-color: #1f2937;
    }
    .fc .fc-scrollgrid {
        border-color: #374151;
    }
    .fc-theme-standard td, .fc-theme-standard th {
        border-color: #374151;
    }
    /* List view dark theme */
    .fc .fc-list {
        border-color: #374151;
    }
    .fc .fc-list-day-cushion {
        background-color: #1f2937;
    }
    .fc .fc-list-day-text,
    .fc .fc-list-day-side-text {
        color: #e5e7eb;
    }
    .fc .fc-list-event td {
        border-color: #374151;
    }
    .fc .fc-list-event-title a {
        color: #e5e7eb;
    }
    .fc .fc-list-empty {
        background-color: #111827;
        color: #9ca3af;
    }
    /* Calendar filter toggles */
    .cal-toggle:not(.active) {
        background-color: transparent;
        border-color: #374151;
        color: #6b7280;
        opacity: 0.5;
    }
    .cal-toggle:not(.active) span {
        opacity: 0.4;
    }
    /* Mobile toolbar */
    @media (max-width: 640px) {
        .fc .fc-toolbar {
            flex-direction: column;
            gap: 0.5rem;
        }
        .fc .fc-toolbar-title {
            font-size: 1.1rem;
        }
        .fc .fc-button {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="mb-6">
    <h1 class="text-2xl font-bold text-white">Calendar</h1>
    <p class="text-sm text-gray-400 mt-1">Tasks, payments, follow-ups, legal filings, and contact dates</p>
</div>

<!-- Toggle filters -->
<div class="flex flex-wrap gap-2 mb-4" id="calendar-filters">
    <button type="button" id="cal-toggle-all" class="cal-toggle active inline-flex items-center gap-1.5 px-3 py-1.5 rounded-md text-xs font-medium border transition-colors bg-gray-700 border-gray-500 text-gray-200">
        All
    </button>
    <span class="border-l border-gray-600 mx-0.5"></span>
    <button type="button" data-type="task" class="cal-toggle active inline-flex items-center gap-1.5 px-3 py-1.5 rounded-md text-xs font-medium border transition-colors bg-yellow-900/30 border-yellow-700 text-yellow-300">
        <span class="w-2 h-2 rounded-full bg-yellow-500 inline-block"></span> Tasks
    </button>
    <button type="button" data-type="meeting" class="cal-toggle active inline-flex items-center gap-1.5 px-3 py-1.5 rounded-md text-xs font-medium border transition-colors bg-blue-900/30 border-blue-700 text-blue-300">
        <span class="w-2 h-2 rounded-full bg-blue-500 inline-block"></span> Meetings
    </button>
    <button type="button" data-type="payment" class="cal-toggle active inline-flex items-center gap-1.5 px-3 py-1.5 rounded-md text-xs font-medium border transition-colors bg-red-900/30 border-red-700 text-red-300">
        <span class="w-2 h-2 rounded-full bg-red-500 inline-block"></span> Payments
    </button>
    <button type="button" data-type="followup" class="cal-toggle active inline-flex items-center gap-1.5 px-3 py-1.5 rounded-md text-xs font-medium border transition-colors bg-amber-900/30 border-amber-700 text-amber-300">
        <span class="w-2 h-2 rounded-full bg-amber-500 inline-block"></span> Follow-ups
    </button>
    <button type="button" data-type="legal" class="cal-toggle active inline-flex items-center gap-1.5 px-3 py-1.5 rounded-md text-xs font-medium border transition-colors bg-purple-900/30 border-purple-700 text-purple-300">
        <span class="w-2 h-2 rounded-full bg-purple-500 inline-block"></span> Legal
    </button>
    <button type="button" data-type="hearing" class="cal-toggle active inline-flex items-center gap-1.5 px-3 py-1.5 rounded-md text-xs font-medium border transition-colors bg-violet-900/30 border-violet-700 text-violet-300">
        <span class="w-2 h-2 rounded-full bg-violet-500 inline-block"></span> Hearings
    </button>
    <button type="button" data-type="contact" class="cal-toggle active inline-flex items-center gap-1.5 px-3 py-1.5 rounded-md text-xs font-medium border transition-colors bg-sky-900/30 border-sky-700 text-sky-300">
        <span class="w-2 h-2 rounded-full bg-sky-500 inline-block"></span> Contacts
    </button>
</div>

<div id="calendar" class="bg-gray-800 rounded-lg border border-gray-700 p-4"></div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var isMobile = window.innerWidth < 640;
        var hiddenTypes = {};

        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: isMobile ? 'listWeek' : 'dayGridMonth',
            headerToolbar: isMobile
                ? { left: 'prev,next', center: 'title', right: 'listWeek,dayGridMonth' }
                : { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,listWeek' },
            events: '{% url "dashboard:calendar_events" %}',
            eventClick: function(info) {
                info.jsEvent.preventDefault();
                if (info.event.url) {
                    window.location.href = info.event.url;
                }
            },
            eventDidMount: function(info) {
                var eventType = info.event.extendedProps.type;
                if (hiddenTypes[eventType]) {
                    info.el.style.display = 'none';
                }
            },
            height: 'auto',
            firstDay: 0,
        });
        calendar.render();

        function applyTypeVisibility(type, visible) {
            hiddenTypes[type] = !visible;
            var restoreDisplay = (type === 'meeting') ? 'block' : 'auto';
            calendar.getEvents().forEach(function(event) {
                if (event.extendedProps.type === type) {
                    event.setProp('display', visible ? restoreDisplay : 'none');
                }
            });
        }

        function updateAllButton() {
            var toggles = document.querySelectorAll('.cal-toggle[data-type]');
            var allActive = Array.from(toggles).every(function(b) { return b.classList.contains('active'); });
            document.getElementById('cal-toggle-all').classList.toggle('active', allActive);
        }

        // Individual type toggles
        document.querySelectorAll('.cal-toggle[data-type]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var type = this.dataset.type;
                this.classList.toggle('active');
                applyTypeVisibility(type, this.classList.contains('active'));
                updateAllButton();
            });
        });

        // All toggle
        document.getElementById('cal-toggle-all').addEventListener('click', function() {
            var toggles = document.querySelectorAll('.cal-toggle[data-type]');
            var anyOff = Array.from(toggles).some(function(b) { return !b.classList.contains('active'); });
            var setActive = anyOff; // if any are off, turn all on; otherwise turn all off
            toggles.forEach(function(btn) {
                var type = btn.dataset.type;
                if (setActive) { btn.classList.add('active'); } else { btn.classList.remove('active'); }
                applyTypeVisibility(type, setActive);
            });
            this.classList.toggle('active', setActive);
        });
    });
</script>
{% endblock %}
